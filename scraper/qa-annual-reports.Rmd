---
title: "QA Wahis Annual Reports"
author: "EcoHealth Alliance"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(DT)
library(DBI)

# connect to database
source(here::here("scraper/packages.R"))
source(here::here("scraper/functions.R"))
conn <- wahis_db_connect()

# reported but failed 
ingest_missing <- dbReadTable(conn, "annual_reports_ingest_status_log") %>% 
  mutate(in_database = as.logical(in_database)) %>%
  filter(!in_database) 

errors_to_check <- ingest_missing %>%
  filter(!str_detect(ingest_error, "failed to fetch"))

# not reported
report_missing <- dbReadTable(conn, "annual_reports_status") %>%
  filter(!reported) %>%
  select(report, country_iso3c, report_year, report_semester, reported) %>%
  mutate(report_year = as.character(report_year))

# all missing
status_missing <- bind_rows(ingest_missing, report_missing)

# function to make dt
make_dt <- function(dat){
  dat %>%
    datatable(class = "row-border", escape = FALSE, rownames = FALSE, extensions = "Buttons", 
              options = list(
                columnDefs = list(list(className = 'dt-center', targets = 0:(dim(.)[2] - 1))),
                pageLength = 5,
                scrollX = TRUE,
                dom = 'Bfrtip',
                buttons = c('csv')
              )
    )
}
```

### Ingest errors that should be checked (error produced unexepectedly in ingest_annual_reports())
```{r errors}
errors_to_check %>%
  select(report, in_database, ingest_error) %>%
  make_dt()
```

```{r animal_diseases}
this_year <- as.numeric(format(Sys.Date(), "%Y"))

animal_diseases <- dbReadTable(conn, "annual_reports_animal_diseases") 
animal_hosts <- dbReadTable(conn, "annual_reports_animal_hosts") 

```

### Cases where there are more new outbreaks than total outbreaks
```{r animal_diseases2}
animal_diseases %>%
  select(report, disease, oie_listed, serotype, disease_population, disease_status, new_outbreaks, total_outbreaks) %>%
  drop_na(new_outbreaks, total_outbreaks) %>%
  filter(new_outbreaks > total_outbreaks) %>%
  make_dt()
```

### Cases where the new outbreaks in the annual report do not match the sum of the new outbreak in the semester reports OR the total outbreaks in the annual report exceed the sum of the total outbreaks in the semester reports 
```{r animal_diseases8}

sum_na <- function(vec) ifelse(all(is.na(vec)), NA_integer_, sum(as.numeric(vec), na.rm = TRUE))


animal_diseases_sem <- animal_diseases %>%
  filter(report_months != "Jan-Dec") %>% 
  group_by(country_iso3c, report_year, disease, serotype) %>% 
  summarize(sum_new_outbreaks_sem = sum_na(new_outbreaks), 
            sum_total_outbreaks_sem = sum_na(total_outbreaks)) %>% 
  ungroup()
  
animal_diseases_ann <- animal_diseases %>%
  filter(report_months == "Jan-Dec") %>%
  group_by(country_iso3c, report_year, disease, serotype) %>% 
  summarize(new_outbreaks_ann = sum_na(new_outbreaks), 
            total_outbreaks_ann = sum_na(total_outbreaks)) %>% 
  ungroup()

full_join(animal_diseases_sem, animal_diseases_ann) %>% 
  mutate(total_outbreak_check = sum_total_outbreaks_sem >= total_outbreaks_ann) %>% # there may be overlap in total outbreaks in semesters. year report should not have more than semester sum
  mutate(new_outbreak_check = sum_new_outbreaks_sem == new_outbreaks_ann) %>% # new outbreaks from semesters should add up to new outbreaks from years
  filter(!total_outbreak_check | ! new_outbreak_check) %>% 
  make_dt()
```

### Cases where the cases in the annual report exceed the sum of the cases in the semester reports 
```{r animal_diseases9}

sum_na <- function(vec) ifelse(all(is.na(vec)), NA_integer_, sum(as.numeric(vec), na.rm = TRUE))


animal_hosts_sem <- animal_hosts %>%
  filter(report_months != "Jan-Dec") %>% 
  group_by(country_iso3c, report_year, disease, serotype, taxa) %>% 
  summarize(sum_cases_sem = sum_na(cases)) %>% 
  ungroup()
  
animal_hosts_ann <- animal_hosts %>%
  filter(report_months == "Jan-Dec") %>% 
  group_by(country_iso3c, report_year, disease, serotype, taxa) %>% 
  summarize(cases_ann = sum_na(cases)) %>% 
  ungroup()

full_join(animal_hosts_sem, animal_hosts_ann) %>% 
  mutate(cases_check = sum_cases_sem >= cases_ann) %>% # there may be overlap in cases in semesters. year report should not have more than semester sum
  filter(!cases_check) %>% 
  make_dt()
```

```{r disconnect}
dbDisconnect(conn)
```


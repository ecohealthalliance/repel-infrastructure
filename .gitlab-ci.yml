stages:
  - prebuild
  - provision

#default:
#  stage: prebuild
#  image: lexauw/ansible-alpine
#  before_script:
#    - ansible-galaxy install -r requirements.yml
#  cache:
#    paths:
#      - .imported_roles
#  when: manual

##provision-s3-buckets:
#  script:
#    - ansible-playbook s3-buckets.yml

build-postgres-image:
  stage: prebuild
  image:
    name: docker/compose:1.22.0
    entrypoint: ["/bin/sh", "-c"]
  services:
    - docker:19.03.1-dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
  before_script:
    - echo "deb https://dl.bintray.com/sobolevn/deb git-secret main" | tee -a /etc/apt/sources.list
    - wget -qO - https://api.bintray.com/users/sobolevn/keys/gpg/public.key | apt-key add -
    - apt-get update && apt-get install -y gawk git-secret
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd repeldb && docker-compose build .
  when: always

#provision-postgres-server:
#  stage: provision
#  script:
#    - ansible-playbook ec2-postgis-server.yml
#  dependencies:
#    - build-postgres-image